<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DOCUMENT_NAME_HERE - HTR Viewer</title>
<script>
// Polyfill for sandboxed environments (e.g. Claude artifact iframe)
// No-op in normal browsers where these methods already exist.
(function(){
  var noop = function(){};
  if (typeof console === 'undefined') window.console = {};
  ['assert','warn','log','error','info','debug','trace','group','groupEnd','time','timeEnd'].forEach(function(m){
    if (!console[m]) console[m] = noop;
  });
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/openseadragon@4/build/openseadragon/openseadragon.min.js"></script>
<style>
:root {
  color-scheme: light dark;
  --claude-orange: #C15F3C;
  --claude-orange-dark: #A14A2F;
  --claude-selection: rgba(193, 95, 60, 0.19);
  --color-background-primary: #faf9f5;
  --color-background-secondary: #f5f4ed;
  --color-background-tertiary: #ebe9e1;
  --color-background-info: #fdf6f3;
  --color-text-primary: #2c2c2c;
  --color-text-secondary: #5c5c5c;
  --color-text-info: #A14A2F;
  --color-border-primary: #d4d2cb;
  --color-accent: var(--claude-orange);
  --color-accent-dark: var(--claude-orange-dark);
  --color-svg-background: #ffffff;
  --color-tooltip-background: rgba(44, 44, 44, 0.95);
  --color-tooltip-text: #faf9f5;
  --border-radius-sm: 4px;
  --border-radius-md: 6px;
  --font-serif: Georgia, "Times New Roman", Times, serif;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --polygon-stroke: rgba(193, 95, 60, 0.85);
  --polygon-fill: rgba(193, 95, 60, 0.18);
  --polygon-hover-stroke: rgba(193, 95, 60, 1);
  --polygon-hover-fill: rgba(193, 95, 60, 0.30);
  --polygon-label-fill: rgba(250, 249, 245, 0.78);
  --polygon-label-hover-fill: rgba(250, 249, 245, 0.88);
  --polygon-label-stroke: rgba(193, 95, 60, 0.6);
  --polygon-label-hover-stroke: rgba(193, 95, 60, 1);
  --label-color: #2c2c2c;
  --confidence-high: #4a8c50;
  --confidence-mid: #c07a2a;
  --confidence-low: #b91c1c;
  --search-match-stroke: rgba(234, 179, 8, 0.85);
  --search-match-fill: rgba(234, 179, 8, 0.20);
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background-primary: #1a1815;
    --color-background-secondary: #201d18;
    --color-background-tertiary: #2a2620;
    --color-background-info: #2a2018;
    --color-text-primary: #e8e6e3;
    --color-text-secondary: #a8a6a3;
    --color-text-info: #e09070;
    --color-border-primary: #3a3632;
    --color-svg-background: #252220;
    --color-tooltip-background: rgba(232, 230, 227, 0.95);
    --color-tooltip-text: #1a1815;
    --polygon-stroke: rgba(224, 144, 112, 0.8);
    --polygon-fill: rgba(224, 144, 112, 0.15);
    --polygon-hover-stroke: rgba(224, 144, 112, 1);
    --polygon-hover-fill: rgba(224, 144, 112, 0.28);
    --polygon-label-fill: rgba(26, 24, 21, 0.78);
    --polygon-label-hover-fill: rgba(26, 24, 21, 0.9);
    --polygon-label-stroke: rgba(224, 144, 112, 0.6);
    --polygon-label-hover-stroke: rgba(224, 144, 112, 1);
    --label-color: #e8e6e3;
    --search-match-stroke: rgba(250, 204, 21, 0.75);
    --search-match-fill: rgba(250, 204, 21, 0.14);
  }
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
::selection { background: var(--claude-selection); }
html, body {
  width: 100%; height: 100%;
  font-family: var(--font-serif);
  color: var(--color-text-primary);
  background: var(--color-background-primary);
  -webkit-font-smoothing: antialiased;
}
.app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

header {
  flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
  gap: 1rem; padding: 0.75rem 1.25rem;
  border-bottom: 1px solid var(--color-border-primary);
  background: var(--color-background-secondary);
}
.header-title { font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-title span { color: var(--color-accent); font-weight: 600; }
.header-controls { display: flex; gap: 0.5rem; flex-shrink: 0; align-items: center; }

.page-nav { display: flex; align-items: center; gap: 0.35rem; flex-shrink: 0; }
.page-indicator {
  font-family: var(--font-mono); font-size: 0.75rem;
  color: var(--color-text-secondary); min-width: 3.5rem; text-align: center;
}
.btn-nav {
  font-family: var(--font-mono); font-size: 0.75rem; padding: 0.3rem 0.55rem;
  border: 1px solid var(--color-border-primary); border-radius: var(--border-radius-sm);
  background: var(--color-background-primary); color: var(--color-text-secondary);
  cursor: pointer; transition: all 0.15s ease; user-select: none; line-height: 1;
}
.btn-nav:hover:not(:disabled) { border-color: var(--color-accent); color: var(--color-accent); }
.btn-nav:disabled { opacity: 0.35; cursor: default; }

.search-box { display: flex; align-items: center; gap: 0.4rem; flex-shrink: 0; }
.search-input {
  font-family: var(--font-mono); font-size: 0.75rem; padding: 0.3rem 0.55rem;
  border: 1px solid var(--color-border-primary); border-radius: var(--border-radius-sm);
  background: var(--color-background-primary); color: var(--color-text-primary);
  width: 150px; outline: none; transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--color-accent); }
.search-input::placeholder { color: var(--color-text-secondary); opacity: 0.6; }
.search-count { font-family: var(--font-mono); font-size: 0.65rem; color: var(--color-text-secondary); white-space: nowrap; }

.btn {
  font-family: var(--font-mono); font-size: 0.75rem; padding: 0.35rem 0.75rem;
  border: 1px solid var(--color-border-primary); border-radius: var(--border-radius-sm);
  background: var(--color-background-primary); color: var(--color-text-secondary);
  cursor: pointer; transition: all 0.15s ease; white-space: nowrap; user-select: none;
}
.btn:hover { border-color: var(--color-accent); color: var(--color-accent); }
.btn.active { background: var(--color-background-info); border-color: var(--color-accent); color: var(--color-text-info); }

.btn-icon {
  display: flex; align-items: center; justify-content: center;
  padding: 0.3rem; border: 1px solid var(--color-border-primary);
  border-radius: var(--border-radius-sm); background: var(--color-background-primary);
  color: var(--color-text-secondary); cursor: pointer; transition: all 0.15s ease;
}
.btn-icon:hover { border-color: var(--color-accent); color: var(--color-accent); }
.btn-icon svg { display: block; }

.opacity-slider {
  width: 50px; height: 3px; cursor: pointer; vertical-align: middle;
  accent-color: var(--color-accent); opacity: 0.7; transition: opacity 0.15s;
}
.opacity-slider:hover { opacity: 1; }

.main { flex: 1; display: flex; overflow: hidden; min-height: 0; }
.viewer {
  flex: 1; position: relative; overflow: hidden;
  background: var(--color-background-tertiary); min-width: 0;
}
#osd-viewer { width: 100%; height: 100%; }
#overlay-svg {
  position: absolute; top: 0; left: 0;
  pointer-events: none; overflow: visible; z-index: 10;
}
#overlay-svg polygon {
  pointer-events: none;
  vector-effect: non-scaling-stroke;
  fill: var(--polygon-fill); stroke: var(--polygon-stroke); stroke-width: 2;
  transition: fill 0.15s, stroke 0.15s;
}
#overlay-svg polygon.active {
  fill: var(--polygon-hover-fill); stroke: var(--polygon-hover-stroke); stroke-width: 3;
}
#overlay-svg polygon.search-match {
  fill: var(--search-match-fill); stroke: var(--search-match-stroke); stroke-width: 3;
}
#overlay-svg polygon.search-match.active {
  fill: var(--polygon-hover-fill); stroke: var(--polygon-hover-stroke); stroke-width: 3.5;
}
.labels-on #overlay-svg polygon {
  fill: var(--polygon-label-fill); stroke: var(--polygon-label-stroke);
}
.labels-on #overlay-svg polygon.active {
  fill: var(--polygon-label-hover-fill); stroke: var(--polygon-label-hover-stroke);
}
#overlay-svg .svg-label {
  pointer-events: none; fill: var(--label-color);
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight: 600;
}
#overlay-svg .svg-label-shadow {
  pointer-events: none;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight: 600;
}

.sidebar {
  flex-shrink: 0; width: 320px; background: var(--color-background-secondary);
  border-left: 1px solid var(--color-border-primary); display: flex; flex-direction: column;
  overflow: hidden; transition: width 0.25s ease, opacity 0.2s ease;
}
.sidebar.collapsed { width: 0; border-left: none; opacity: 0; pointer-events: none; }
.sidebar-header {
  flex-shrink: 0; padding: 0.85rem 1rem; border-bottom: 1px solid var(--color-border-primary);
  display: flex; align-items: center; justify-content: space-between;
}
.sidebar-header h2 { font-family: var(--font-mono); font-size: 0.7rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-secondary); }
.sidebar-close {
  background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 0.2rem;
  border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center;
  transition: color 0.15s, background 0.15s;
}
.sidebar-close:hover { color: var(--color-text-primary); background: var(--color-background-tertiary); }
.sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
.line-item {
  padding: 0.5rem 0.65rem; border-radius: var(--border-radius-sm); margin-bottom: 0.25rem;
  cursor: pointer; transition: background 0.12s; border-left: 3px solid transparent;
}
.line-item:hover, .line-item.highlight { background: var(--claude-selection); border-left-color: var(--color-accent); }
.line-item.search-match { background: rgba(234, 179, 8, 0.12); border-left-color: var(--search-match-stroke); }
.line-text { font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-text-primary); line-height: 1.4; }
.line-meta { font-family: var(--font-mono); font-size: 0.65rem; color: var(--color-text-secondary); margin-top: 0.15rem; display: flex; align-items: center; gap: 0.35rem; }
.conf-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

.tooltip {
  position: fixed; pointer-events: none; z-index: 1000;
  background: var(--color-tooltip-background); color: var(--color-tooltip-text);
  border-radius: var(--border-radius-md); padding: 0.55rem 0.8rem; max-width: 400px;
  opacity: 0; transform: translateY(4px); transition: opacity 0.12s, transform 0.12s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}
.tooltip.visible { opacity: 1; transform: translateY(0); }
.tooltip-text { font-family: var(--font-mono); font-size: 0.82rem; font-weight: 500; line-height: 1.4; margin-bottom: 0.25rem; }
.tooltip-meta { font-family: var(--font-mono); font-size: 0.65rem; opacity: 0.75; display: flex; align-items: center; gap: 0.4rem; }

@media (max-width: 700px) {
  .sidebar { position: fixed; right: 0; top: 0; bottom: 0; z-index: 900; width: 85vw; max-width: 320px; box-shadow: -4px 0 24px rgba(0,0,0,0.15); }
  .sidebar.collapsed { width: 0; box-shadow: none; }
  header { padding: 0.6rem 0.75rem; flex-wrap: wrap; }
  .search-input { width: 110px; }
}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="header-title"><span>HTR</span> Viewer &middot; DOCUMENT_NAME_HERE</div>
    <div class="page-nav" id="pageNav">
      <button class="btn-nav" id="btnPrev" onclick="prevPage()">&lsaquo;</button>
      <span class="page-indicator" id="pageIndicator">1 / 1</span>
      <button class="btn-nav" id="btnNext" onclick="nextPage()">&rsaquo;</button>
    </div>
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="Search lines..." oninput="doSearch(this.value)">
      <span class="search-count" id="searchCount"></span>
    </div>
    <div class="header-controls">
      <button class="btn-icon" onclick="osdZoomIn()" title="Zoom in">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="7" cy="7" r="4.5"/><line x1="10.2" y1="10.2" x2="14" y2="14"/><line x1="5" y1="7" x2="9" y2="7"/><line x1="7" y1="5" x2="7" y2="9"/></svg>
      </button>
      <button class="btn-icon" onclick="osdZoomOut()" title="Zoom out">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="7" cy="7" r="4.5"/><line x1="10.2" y1="10.2" x2="14" y2="14"/><line x1="5" y1="7" x2="9" y2="7"/></svg>
      </button>
      <button class="btn-icon" onclick="osdHome()" title="Fit to view">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M2 6V2h4"/><path d="M14 6V2h-4"/><path d="M2 10v4h4"/><path d="M14 10v4h-4"/></svg>
      </button>
      <button class="btn" id="btnCopy" onclick="copyAllText()">Copy Text</button>
      <button class="btn" id="btnDownloadImg" onclick="downloadImage()">Image</button>
      <a class="btn" id="btnExport" href="EXPORT_URL_HERE" download style="text-decoration:none">EXPORT_FORMAT_HERE</a>
      <button class="btn active" id="btnPolygons" onclick="togglePolygons()">Polygons</button>
      <input type="range" class="opacity-slider" id="opacitySlider" min="5" max="100" value="50" title="Polygon opacity" oninput="updatePolygonOpacity(this.value)">
      <button class="btn" id="btnLabels" onclick="toggleLabels()">Labels</button>
      <button class="btn" id="btnLines" onclick="toggleSidebar()">Lines</button>
    </div>
  </header>
  <div class="main">
    <div class="viewer">
      <div id="osd-viewer"></div>
    </div>
    <div class="sidebar collapsed" id="sidebar">
      <div class="sidebar-header">
        <h2>Transcribed Lines</h2>
        <button class="sidebar-close" onclick="toggleSidebar()" title="Close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="4" y1="4" x2="12" y2="12"/><line x1="12" y1="4" x2="4" y2="12"/></svg>
        </button>
      </div>
      <div class="sidebar-list" id="lineList"></div>
    </div>
  </div>
</div>
<div class="tooltip" id="tooltip">
  <div class="tooltip-text" id="ttText"></div>
  <div class="tooltip-meta" id="ttMeta"></div>
</div>

<script>
var SVG_NS = 'http://www.w3.org/2000/svg';
var pages = PAGES_DATA_HERE;
var currentPageIdx = 0;
var viewer = null;
var svgEl = null;
var activeLineIdx = -1;
var showPolygons = true;
var showLabels = false;
var polygonOpacity = 0.5;
var searchQuery = '';
var searchMatches = [];

var lineListEl, sidebarEl, appEl, pageNav, pageIndicator, btnPrev, btnNext;
var searchCountEl, tooltip, ttText, ttMeta;

function init() {
  lineListEl = document.getElementById('lineList');
  sidebarEl = document.getElementById('sidebar');
  appEl = document.getElementById('app');
  pageNav = document.getElementById('pageNav');
  pageIndicator = document.getElementById('pageIndicator');
  btnPrev = document.getElementById('btnPrev');
  btnNext = document.getElementById('btnNext');
  searchCountEl = document.getElementById('searchCount');
  tooltip = document.getElementById('tooltip');
  ttText = document.getElementById('ttText');
  ttMeta = document.getElementById('ttMeta');

  if (pages.length <= 1) pageNav.style.display = 'none';

  viewer = OpenSeadragon({
    id: 'osd-viewer',
    prefixUrl: '',
    showNavigationControl: false,
    animationTime: 0.3,
    blendTime: 0.1,
    minZoomImageRatio: 0.8,
    maxZoomPixelRatio: 15,
    visibilityRatio: 0.8,
    constrainDuringPan: true,
    immediateRender: true,
    crossOriginPolicy: 'Anonymous',
    gestureSettingsMouse: { dblClickToZoom: true, clickToZoom: false },
    gestureSettingsTouch: { dblClickToZoom: true, clickToZoom: false, pinchToZoom: true },
  });

  svgEl = document.createElementNS(SVG_NS, 'svg');
  svgEl.id = 'overlay-svg';
  svgEl.setAttribute('preserveAspectRatio', 'none');
  viewer.container.appendChild(svgEl);

  viewer.addHandler('open', onViewerOpen);
  viewer.addHandler('animation', syncOverlay);
  viewer.addHandler('animation-finish', syncOverlay);
  viewer.addHandler('resize', syncOverlay);
  viewer.addHandler('canvas-click', onCanvasClick);
  viewer.addHandler('canvas-double-click', onCanvasDblClick);

  viewer.element.addEventListener('mousemove', onMouseMove);
  viewer.element.addEventListener('mouseleave', function() { handleHover(-1, null); });

  renderPage(0);
}

/* --- OSD integration --- */

function onViewerOpen() {
  var page = pages[currentPageIdx];
  svgEl.setAttribute('viewBox', '0 0 ' + page.width + ' ' + page.height);
  renderOverlay(page.lines);
  syncOverlay();
}

function syncOverlay() {
  var ti = viewer.world.getItemAt(0);
  if (!ti) return;
  var bounds = ti.getBounds();
  var tl = viewer.viewport.viewportToViewerElementCoordinates(bounds.getTopLeft());
  var br = viewer.viewport.viewportToViewerElementCoordinates(bounds.getBottomRight());
  svgEl.style.left = tl.x + 'px';
  svgEl.style.top = tl.y + 'px';
  svgEl.style.width = (br.x - tl.x) + 'px';
  svgEl.style.height = (br.y - tl.y) + 'px';
}

function hitTestLine(imgX, imgY) {
  var lines = currentLines();
  for (var i = 0; i < lines.length; i++) {
    var b = lines[i].bbox;
    if (imgX >= b.xmin && imgX <= b.xmax && imgY >= b.ymin && imgY <= b.ymax) return i;
  }
  return -1;
}

function imagePointFromEvent(position) {
  var ti = viewer.world.getItemAt(0);
  if (!ti) return null;
  var vp = viewer.viewport.pointFromPixel(position);
  return ti.viewportToImageCoordinates(vp);
}

function onMouseMove(e) {
  if (!viewer || !viewer.isOpen()) return;
  var rect = viewer.element.getBoundingClientRect();
  var pos = new OpenSeadragon.Point(e.clientX - rect.left, e.clientY - rect.top);
  var ip = imagePointFromEvent(pos);
  if (!ip) return;
  handleHover(hitTestLine(ip.x, ip.y), e);
}

function onCanvasClick(event) {
  if (!event.quick) return;
  var ip = imagePointFromEvent(event.position);
  if (!ip) return;
  var hitIdx = hitTestLine(ip.x, ip.y);
  if (hitIdx >= 0) {
    event.preventDefaultAction = true;
    zoomToLine(hitIdx);
  }
}

function onCanvasDblClick(event) {
  var ip = imagePointFromEvent(event.position);
  if (!ip) return;
  if (hitTestLine(ip.x, ip.y) >= 0) event.preventDefaultAction = true;
}

function osdZoomIn() { viewer.viewport.zoomBy(1.5); viewer.viewport.applyConstraints(); }
function osdZoomOut() { viewer.viewport.zoomBy(0.67); viewer.viewport.applyConstraints(); }
function osdHome() { viewer.viewport.goHome(); }

/* --- Page navigation --- */

function renderPage(idx) {
  currentPageIdx = idx;
  activeLineIdx = -1;
  pageIndicator.textContent = (idx + 1) + ' / ' + pages.length;
  btnPrev.disabled = idx === 0;
  btnNext.disabled = idx === pages.length - 1;
  lineListEl.innerHTML = '';
  svgEl.innerHTML = '';
  viewer.open({ type: 'image', url: pages[idx].image_url });
}
function prevPage() { if (currentPageIdx > 0) renderPage(currentPageIdx - 1); }
function nextPage() { if (currentPageIdx < pages.length - 1) renderPage(currentPageIdx + 1); }
function currentLines() { return pages[currentPageIdx].lines; }

/* --- Rendering --- */

function confColor(c) {
  if (c >= 0.9) return 'var(--confidence-high)';
  if (c >= 0.5) return 'var(--confidence-mid)';
  return 'var(--confidence-low)';
}

function fitFontSize(ln) {
  var h = ln.bbox.ymax - ln.bbox.ymin;
  var w = ln.bbox.xmax - ln.bbox.xmin;
  var charW = w / Math.max(ln.text.length, 1);
  return Math.min(h * 0.68, charW * 1.6, 60);
}

function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function renderOverlay(lines) {
  svgEl.innerHTML = '';
  lineListEl.innerHTML = '';

  lines.forEach(function(ln, i) {
    var poly = document.createElementNS(SVG_NS, 'polygon');
    poly.setAttribute('points', ln.polygon);
    poly.id = 'poly-' + i;
    poly.style.opacity = showPolygons ? polygonOpacity : '0';
    svgEl.appendChild(poly);

    var fontSize = fitFontSize(ln);
    var cx = (ln.bbox.xmin + ln.bbox.xmax) / 2;
    var cy = (ln.bbox.ymin + ln.bbox.ymax) / 2 + fontSize * 0.35;

    var shadow = document.createElementNS(SVG_NS, 'text');
    shadow.setAttribute('x', cx); shadow.setAttribute('y', cy);
    shadow.setAttribute('text-anchor', 'middle'); shadow.setAttribute('font-size', fontSize);
    shadow.setAttribute('class', 'svg-label-shadow');
    shadow.setAttribute('stroke', 'var(--polygon-label-fill)');
    shadow.setAttribute('stroke-width', '5'); shadow.setAttribute('stroke-linejoin', 'round');
    shadow.textContent = ln.text;
    shadow.id = 'shadow-' + i;
    shadow.style.display = showLabels ? '' : 'none';
    svgEl.appendChild(shadow);

    var label = document.createElementNS(SVG_NS, 'text');
    label.setAttribute('x', cx); label.setAttribute('y', cy);
    label.setAttribute('text-anchor', 'middle'); label.setAttribute('font-size', fontSize);
    label.setAttribute('class', 'svg-label');
    label.textContent = ln.text;
    label.id = 'label-' + i;
    label.style.display = showLabels ? '' : 'none';
    svgEl.appendChild(label);

    var div = document.createElement('div');
    div.className = 'line-item'; div.id = 'item-' + i;
    div.innerHTML = '<div class="line-text">' + escapeHtml(ln.text) + '</div>'
      + '<div class="line-meta"><span class="conf-dot" style="background:' + confColor(ln.confidence) + '"></span>'
      + (ln.confidence * 100).toFixed(1) + '%</div>';
    div.addEventListener('mouseenter', function() { handleHover(i, null); });
    div.addEventListener('mouseleave', function() { handleHover(-1, null); });
    div.addEventListener('click', function() { zoomToLine(i); });
    lineListEl.appendChild(div);
  });

  applySearchHighlights();
}

/* --- Hover & tooltip --- */

function handleHover(hitIdx, mouseEvent) {
  if (hitIdx === activeLineIdx) {
    if (hitIdx >= 0 && mouseEvent) moveTooltip(mouseEvent);
    return;
  }
  if (activeLineIdx >= 0) deactivate(activeLineIdx);
  activeLineIdx = hitIdx;
  if (hitIdx >= 0) activate(hitIdx, mouseEvent);
}

function activate(i, e) {
  var ln = currentLines()[i];
  var poly = document.getElementById('poly-' + i);
  if (poly) { poly.classList.add('active'); poly.style.opacity = '1'; }
  var item = document.getElementById('item-' + i);
  if (item) item.classList.add('highlight');
  ttText.textContent = ln.text;
  ttMeta.innerHTML = '<span class="conf-dot" style="background:' + confColor(ln.confidence) + '"></span>' + (ln.confidence * 100).toFixed(1) + '% confidence';
  if (e) { moveTooltip(e); tooltip.classList.add('visible'); }
}

function deactivate(i) {
  var poly = document.getElementById('poly-' + i);
  if (poly) {
    poly.classList.remove('active');
    poly.style.opacity = poly.classList.contains('search-match') ? '1' : (showPolygons ? polygonOpacity : '0');
  }
  var item = document.getElementById('item-' + i);
  if (item) item.classList.remove('highlight');
  tooltip.classList.remove('visible');
}

function moveTooltip(e) {
  var x = e.clientX + 12, y = e.clientY + 12;
  if (x + 300 > window.innerWidth) x = e.clientX - 300 - 12;
  if (y + 80 > window.innerHeight) y = e.clientY - 80 - 12;
  tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
}

/* --- Zoom to line --- */

function zoomToLine(i) {
  var page = pages[currentPageIdx];
  var ln = page.lines[i];
  var w = page.width;
  var pad = 2;
  var bx = ln.bbox.xmin / w;
  var by = ln.bbox.ymin / w;
  var bw = (ln.bbox.xmax - ln.bbox.xmin) / w;
  var bh = (ln.bbox.ymax - ln.bbox.ymin) / w;
  viewer.viewport.fitBounds(new OpenSeadragon.Rect(
    bx - bw * pad, by - bh * pad,
    bw * (1 + 2 * pad), bh * (1 + 2 * pad)
  ));
  if (activeLineIdx >= 0 && activeLineIdx !== i) deactivate(activeLineIdx);
  activate(i, null);
  activeLineIdx = i;
  var item = document.getElementById('item-' + i);
  if (item && !sidebarEl.classList.contains('collapsed')) {
    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

/* --- Toggles --- */

function togglePolygons() {
  showPolygons = !showPolygons;
  document.getElementById('btnPolygons').classList.toggle('active', showPolygons);
  svgEl.querySelectorAll('polygon').forEach(function(p) {
    if (p.classList.contains('active') || p.classList.contains('search-match')) return;
    p.style.opacity = showPolygons ? polygonOpacity : '0';
  });
}

function updatePolygonOpacity(val) {
  polygonOpacity = val / 100;
  svgEl.querySelectorAll('polygon').forEach(function(p) {
    if (p.classList.contains('active') || p.classList.contains('search-match')) return;
    if (showPolygons) p.style.opacity = polygonOpacity;
  });
}

function toggleLabels() {
  showLabels = !showLabels;
  document.getElementById('btnLabels').classList.toggle('active', showLabels);
  appEl.classList.toggle('labels-on', showLabels);
  svgEl.querySelectorAll('.svg-label, .svg-label-shadow').forEach(function(l) { l.style.display = showLabels ? '' : 'none'; });
}

function toggleSidebar() {
  var open = sidebarEl.classList.toggle('collapsed');
  document.getElementById('btnLines').classList.toggle('active', !open);
}

/* --- Search --- */

function doSearch(query) {
  searchQuery = query.toLowerCase().trim();
  searchMatches = [];
  if (!searchQuery) { clearSearchHighlights(); searchCountEl.textContent = ''; return; }

  pages.forEach(function(page, pageIdx) {
    page.lines.forEach(function(line, lineIdx) {
      if (line.text && line.text.toLowerCase().indexOf(searchQuery) !== -1)
        searchMatches.push({ pageIdx: pageIdx, lineIdx: lineIdx });
    });
  });

  var pageCount = new Set(searchMatches.map(function(m) { return m.pageIdx; })).size;
  if (searchMatches.length === 0) { searchCountEl.textContent = 'No matches'; }
  else if (pages.length > 1) { searchCountEl.textContent = searchMatches.length + ' in ' + pageCount + (pageCount === 1 ? ' page' : ' pages'); }
  else { searchCountEl.textContent = searchMatches.length + ' found'; }

  var hasOnCurrent = searchMatches.some(function(m) { return m.pageIdx === currentPageIdx; });
  if (!hasOnCurrent && searchMatches.length > 0) renderPage(searchMatches[0].pageIdx);
  else applySearchHighlights();
}

function applySearchHighlights() {
  clearSearchHighlights();
  if (!searchQuery) return;
  var firstMatch = null;
  searchMatches.filter(function(m) { return m.pageIdx === currentPageIdx; }).forEach(function(m) {
    var poly = document.getElementById('poly-' + m.lineIdx);
    if (poly) { poly.classList.add('search-match'); poly.style.opacity = '1'; }
    var item = document.getElementById('item-' + m.lineIdx);
    if (item) { item.classList.add('search-match'); if (!firstMatch) firstMatch = item; }
  });
  if (firstMatch && !sidebarEl.classList.contains('collapsed'))
    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearSearchHighlights() {
  svgEl.querySelectorAll('polygon.search-match').forEach(function(p) {
    p.classList.remove('search-match');
    if (!p.classList.contains('active')) p.style.opacity = showPolygons ? polygonOpacity : '0';
  });
  lineListEl.querySelectorAll('.line-item.search-match').forEach(function(el) { el.classList.remove('search-match'); });
}

/* --- Downloads --- */

function getAllText() {
  return pages.flatMap(function(p) { return p.lines.map(function(l) { return l.text || ''; }); }).join('\n');
}

function copyAllText() {
  navigator.clipboard.writeText(getAllText()).then(function() {
    var btn = document.getElementById('btnCopy');
    btn.textContent = 'Copied!'; btn.classList.add('active');
    setTimeout(function() { btn.textContent = 'Copy Text'; btn.classList.remove('active'); }, 2000);
  });
}

function downloadImage() {
  var page = pages[currentPageIdx];
  var a = document.createElement('a');
  a.href = page.image_url;
  a.download = 'page_' + (currentPageIdx + 1) + '.png';
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

init();
</script>
</body>
</html>
